H5PEditor.ImageEditingPopup=function(e,t){var i=0,a=!1;function n(d){t.call(this);var r,s,c=this,g=i,h=!1,p=!1,m=0,l=document.createElement("div");l.className="h5p-editing-image-popup-background hidden";var u=document.createElement("div");u.className="h5p-editing-image-popup",l.appendChild(u);var v=document.createElement("div");v.className="h5p-editing-image-header",u.appendChild(v);var f=document.createElement("div");f.className="h5p-editing-image-header-title",f.textContent=H5PEditor.t("core","editImage"),v.appendChild(f);var b=document.createElement("div");b.className="h5p-editing-image-header-buttons",v.appendChild(b);var H=document.createElement("div");H.className="h5p-editing-image-editing-container",u.appendChild(H);var P=document.createElement("div");P.className="h5p-editing-image-loading",P.textContent=ns.t("core","loadingImageEditor"),u.appendChild(P);var k=new Image;k.className="h5p-editing-image hidden",k.id="h5p-editing-image-"+g,H.appendChild(k),l.addEventListener("click",function(){this.hide()}.bind(this)),u.addEventListener("click",(function(e){e.stopPropagation()})),i+=1;var E=function(e,t,i){var a=document.createElement("button");a.textContent=ns.t("core",e),a.className=t,a.addEventListener("click",i),b.appendChild(a)},L=function(){window.requestAnimationFrame((function(){c.darkroom=new Darkroom("#h5p-editing-image-"+g,{initialize:function(){this.transformations=[],H5P.$body.get(0).classList.add("h5p-editor-image-popup"),l.classList.remove("hidden"),P.classList.add("hidden"),c.trigger("initialized")},maxWidth:r,maxHeight:s,plugins:{crop:{ratio:d||null},save:!1}})}))},C=function(t,i){e.ajax({url:t,dataType:"script",success:function(){i&&i()},async:!0})};this.adjustPopupOffset=function(e){e&&(m=e.top);var t,i=.65*screen.height,a=n.staticDimensions,o=H5P.$body.get(0).offsetHeight-a.backgroundPaddingHeight,d=a.darkroomToolbarHeight+a.popupHeaderHeight+a.darkroomPadding,s=o-d,c=i<s?i:s;if(k.naturalHeight<c)t=k.naturalHeight;else{t=c;var g=k.naturalHeight/k.naturalWidth,h=r*g;h<t&&(t=h)}var p=t+d,l=m-p/2-a.backgroundPaddingHeight/2;if(p+(l=l>0?l:0)>o){var v=o-p;l=v<0?0:v}u.style.top=l+"px"},this.setImage=function(e){var t=u.querySelector(".darkroom-container");t&&t.parentNode.removeChild(t),H5P.setSource(k,e,H5PEditor.contentId),k.onload=function(){L(),k.onload=null},P.classList.remove("hidden"),k.classList.add("hidden"),H.appendChild(k)},this.show=function(e,t){if(H5P.$body.get(0).appendChild(l),l.classList.remove("hidden"),function(){var e=n.staticDimensions;r=l.offsetWidth-e.backgroundPaddingWidth-e.darkroomPadding;var t=screen.height*e.maxScreenHeightPercentage,i=l.offsetHeight-e.backgroundPaddingHeight-e.popupHeaderHeight-e.darkroomToolbarHeight-e.darkroomPadding;s=t<i?t:i}(),l.classList.add("hidden"),t){if(a?c.setImage(t):(H5P.setSource(k,t,H5PEditor.contentId),C(H5PEditor.basePath+"libs/fabric.js",(function(){C(H5PEditor.basePath+"libs/darkroom.js",(function(){L(),a=!0}))}))),e){var i=function(){this.adjustPopupOffset(e),k.removeEventListener("load",i)}.bind(this);k.addEventListener("load",i)}}else H5P.$body.get(0).classList.add("h5p-editor-image-popup"),l.classList.remove("hidden"),c.trigger("initialized");h=!0},this.hide=function(){h=!1,H5P.$body.get(0).classList.remove("h5p-editor-image-popup"),l.classList.add("hidden"),H5P.$body.get(0).removeChild(l)},this.toggle=function(){h?this.hide():this.show()},E("resetToOriginalLabel","h5p-editing-image-reset-button h5p-remove",(function(){c.trigger("resetImage"),p=!0})),E("cancelLabel","h5p-editing-image-cancel-button",(function(){c.trigger("canceled"),c.hide()})),E("saveLabel","h5p-editing-image-save-button h5p-done",(function(){var e,t,i;e=c.darkroom.plugins.crop.hasFocus(),t=c.darkroom.canvas.getElement(),i=function(){const e=function(e){c.trigger("savedImage",e),t.removeEventListener("crop:update",i,!1)};c.darkroom.canvas.contextContainer.canvas.toBlob?c.darkroom.canvas.contextContainer.canvas.toBlob(e,c.mime):e(o(c.darkroom.canvas.toDataURL({format:c.mime.split("/")[1]})))},(c.darkroom.transformations.length||p||e)&&(e?(c.darkroom.plugins.crop.cropCurrentZone(),t.addEventListener("crop:update",i,!1)):i()),p=!1,c.hide()}))}n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.staticDimensions={backgroundPaddingWidth:32,backgroundPaddingHeight:96,darkroomPadding:64,darkroomToolbarHeight:40,maxScreenHeightPercentage:.65,popupHeaderHeight:59};const o=function(e){const t=e.split(","),i=t[0].match(/data:(.*);base64/i)[1],a=atob(t[1]),n=new Uint8Array(a.length);for(let e=0;e<a.length;e++)n[e]=a.charCodeAt(e);return new Blob([n],{type:i})};return n}(H5P.jQuery,H5P.EventDispatcher);