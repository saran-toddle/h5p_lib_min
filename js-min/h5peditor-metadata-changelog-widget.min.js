H5PEditor.metadataChangelogWidget=function(t,e,a,i){e.changes||(e.changes=[]);var n=H5PEditor.$,d={editing:!1,newLog:!1,currentLog:void 0},o=n('<div class="field h5p-metadata-changelog"></div>');H5PEditor.processSemanticsChunk(t,{},o,i);var r=H5PEditor.findField("change",i),c=H5PEditor.findField("date",r),l=H5PEditor.findField("author",r),p=H5PEditor.findField("log",r),s=r.$content,g=c.$item.add(l.$item).add(p.$item),h=n("<div>",{class:"h5peditor-field-description",text:H5PEditor.t("core","changelogDescription")});s.append(h);var u=n("<button>",{class:"h5p-metadata-button h5p-cancel",type:"button",text:H5PEditor.t("core","cancel"),click:function(){P(),d.editing=!1,d.currentLog=void 0,E()}}),v=n("<button>",{class:"h5p-metadata-button inverted h5p-log-change",type:"button",text:H5PEditor.t("core","logThisChange"),click:function(){var t=$(!1);t.date&&t.author&&t.log&&(void 0!==d.currentLog?e.changes[d.currentLog]=t:(e.changes.push(t),d.newLog=!0),d.editing=!1,P(),E(),d.currentLog=void 0)}}),m=n("<button>",{class:"h5p-metadata-button inverted h5p-add-author",type:"button",text:H5PEditor.t("core","addNewChange"),click:function(){d.editing=!0,d.newLog=!1,P(),E()}}),f=n('<div class="h5p-metadata-changelog-buttons"></div>');f.append(u),f.append(v),f.append(m),s.append(f);var b=n("<div",{class:"h5p-metadata-new-log-message",text:H5PEditor.t("core","newChangeHasBeenLogged"),appendTo:s}),H=n("<div>",{class:"h5p-metadata-logged-changes",appendTo:s});function P(){c.$input.val(""),p.$input.val(""),$(!0)}function E(){var t,a,i;b.toggle(d.newLog),h.toggle(!d.editing),m.toggle(!d.editing),u.toggle(d.editing),v.toggle(d.editing),g.toggle(d.editing),d.editing?(!function(){if(void 0!==d.currentLog){$(!0);var t=e.changes[d.currentLog];c.$input.val(t.date);var a=document.createElement("div");a.innerHTML=H5PEditor.htmlspecialchars(t.author),l.$input.val(a.textContent),a.innerHTML=H5PEditor.htmlspecialchars(t.log),p.$input.val(a.textContent)}}(),c.$input.hasClass("datepicker")||(c.$input.addClass("datepicker"),t=c.$input,a=function(){t.Zebra_DatePicker({format:"d-m-y G:i:s",onClose:function(){c.validate()}})},t.Zebra_DatePicker?a():(i=a,n.ajax({url:H5PEditor.basePath+"libs/zebra_datepicker.min.js",dataType:"script",success:i,error:function(t,e){console.warn("error loading libraries: ",e)},async:!0})))):function(){if(H.empty(),H.append('<span class="h5peditor-label h5p-metadata-log-wrapper-title">'+H5PEditor.t("core","loggedChanges")+"</span>"),0==e.changes.length)H.append(n('<div class="h5peditor-field-description">'+H5PEditor.t("core","noChangesHaveBeenLogged")+"</div>"));else{var t=n('<div class="h5p-metadata-log-wrapper"></div>');H.append(t);for(var a=0;a<e.changes.length;a++){var i=e.changes[a],d=n("<div>",{class:"h5p-metadata-log-date",html:H5PEditor.htmlspecialchars(i.date)}),o=n("<div>",{class:"h5p-metadata-log-description",html:H5PEditor.htmlspecialchars(i.log)}),r=n("<div>",{class:"h5p-metadata-log-author",html:"by "+H5PEditor.htmlspecialchars(i.author)}),c=n('<div class="h5p-metadata-description-wrapper"></div>');c.append(o),c.append(r);var l=n('<div class="h5p-metadata-log-buttons"><button type="button" class="h5p-metadata-edit h5p-metadata-icon-button"></button><button type="button" class="h5p-metadata-delete h5p-metadata-icon-button"></button></div>');l.find(".h5p-metadata-delete").click((function(){if(confirm(H5PEditor.t("core","confirmDeleteChangeLog"))){var t=n(this).closest(".h5p-metadata-log");C(n(t).data("index"))}})),l.find(".h5p-metadata-edit").click((function(){var t=n(this).closest(".h5p-metadata-log");L(n(t).data("index"))}));var p=n("<div>",{class:"h5p-metadata-log","data-index":a});p.append(d),p.append(c),p.append(l),t.prepend(p)}}}(),H.toggleClass("editing",d.editing)}function L(t){d.editing=!0,d.currentLog=t,d.newLog=!1,E()}function C(t){e.changes.splice(t,1),E()}function $(t){return c.field.optional=t,l.field.optional=t,p.field.optional=t,{date:c.validate(),author:l.validate(),log:p.validate()}}o.appendTo(a),E()};