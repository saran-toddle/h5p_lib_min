ns.Form=function(e,t,a){var n=this;this.params={},this.passReadies=!1,this.commonFields={},this.$form=ns.$('<div class="h5peditor-form"><div class="tree"></div><div class="common collapsed hidden"><div class="fields"><p class="desc">'+ns.t("core","commonFieldsDescription")+'</p><div class="h5peditor-language-switcher"><label class="language-label" for="h5peditor-language-switcher">'+ns.t("core","language")+':</label><select id="h5peditor-language-switcher"><option value="-">'+ns.t("core","noLanguagesSupported")+'</option></select></div><div class="h5peditor-language-notice"><div class="first"></div><div class="last"></div></div></div></div></div>'),this.$common=this.$form.find(".common > .fields"),void 0!==ns.FullscreenBar&&-1===e.indexOf("H5P.CoursePresentation")&&-1===e.indexOf("H5P.BranchingScenario")&&-1===e.indexOf("H5P.InteractiveVideo")&&ns.FullscreenBar(this.$form,e),this.zebra="odd";const s=this.$form.find(".h5peditor-language-switcher select"),i=this.$form.find(".h5peditor-language-notice"),o=[],r={};ns.defaultLanguage=ns.contentLanguage,a&&(ns.defaultLanguage=a);const l=function(){let e="";for(let t in r){let a=ns.supportedLanguages[t]?ns.supportedLanguages[t]:t.toLocaleUpperCase();e+='<option value="'+t+'"'+(t===ns.defaultLanguage?" selected":"")+">"+a+"</option>"}return e},d=function(e,t,a){for(let n=0;n<t.length;n++){if(t[n]===e)return a[n];if(void 0!==t[n].fields&&t[n].fields.length&&void 0!==a[n].fields&&a[n].fields.length){const s=d(e,t[n].fields,a[n].fields);if(void 0!==s)return s}if(void 0!==t[n].field&&void 0!==a[n].field){const s=d(e,[t[n].field],[a[n].field]);if(void 0!==s)return s}}},c=function(e,t){if(void 0!==e.default)return e.default;if(void 0!==e.fields&&e.fields.length){if(1===e.fields.length)return c(e.fields[0],t.fields[0]);const a={};for(let n=0;n<e.fields.length;n++)a[t.fields[n].name]=c(e.fields[n],t.fields[n]);return a}return void 0!==e.field?c(e.field,t.field):void 0};n.addLanguages=function(e,t){for(let a=0;a<t.length;a++){const n=t[a];void 0===r[n]?r[n]=[e]:r[n].push(e)}o.push(e),s.html(l())},n.removeLanguages=function(e,t){for(let a=0;a<t.length;a++){const n=t[a];void 0!==r[n]&&(1===r[n].length?delete r[n]:r[n].splice(r[n].indexOf(e),1))}o.splice(o.indexOf(e),1),s.html(l())},s.change((function(e){const t=new H5P.ConfirmationDialog({headerText:ns.t("core","changeLanguage",{":language":ns.supportedLanguages[this.value]?ns.supportedLanguages[this.value]:this.value.toLocaleUpperCase()}),dialogText:ns.t("core","thisWillPotentially")}).appendTo(document.body);t.on("confirmed",(function(){const e=ns.defaultLanguage=s.val(),t=ns.supportedLanguages[e]?ns.supportedLanguages[e]:e.toLocaleUpperCase();n.metadata.defaultLanguage=e,n.params=n.setSubContentDefaultLanguage(n.params,e),r[e].length!==o.length?(i.children(".first").html(ns.t("core","notAllTextsChanged",{":language":t})),i.children(".last").html(ns.t("core","contributeTranslations",{":language":t,":url":"https://h5p.org/contributing#translating"})),i.addClass("show")):i.removeClass("show"),s.prop("disabled","disabled"),function(e,t){const a=[];for(let t in ns.libraryCache)0!==ns.libraryCache[t]&&void 0!==ns.libraryCache[t].translation[e]||a.push(t);a.length?ns.$.post(ns.getAjaxUrl("translations",{language:e}),{libraries:a},(function(a){for(let t in a.data)ns.libraryCache[t].translation[e]=JSON.parse(a.data[t]).semantics;t()})):t()}(e,(function(){!function(e){r[e];for(let t in ns.libraryCache){if(ns.renderableCommonFields[t]&&ns.renderableCommonFields[t].fields)for(let a=0;a<ns.renderableCommonFields[t].fields.length;a++){const n=ns.renderableCommonFields[t].fields[a],s=ns.libraryCache[t].translation[e];if(void 0===n.instance||void 0===s)continue;const i=d(n.field,ns.libraryCache[t].semantics,s),o=c(i,n.field);n.instance.forceValue(o)}void 0!==ns.libraryCache[t].translation[e]&&ns.updateCommonFieldsDefault(ns.libraryCache[t].semantics,ns.libraryCache[t].translation[e])}}(e),s.prop("disabled",!1)}))})),t.on("canceled",(function(){s.val(ns.defaultLanguage)})),t.show(s.offset().top)})),n.addLanguages(e,t)},ns.Form.prototype.setSubContentDefaultLanguage=function(e,t){if(!e)return e;const a=this;if(Array.isArray(e))e=e.map((function(e){return a.setSubContentDefaultLanguage(e,t)}));else if("object"==typeof e){e.metadata&&(e.metadata.defaultLanguage=t);for(let a in e)e.hasOwnProperty(a)&&(e[a]=this.setSubContentDefaultLanguage(e[a],t))}return e},ns.Form.prototype.replace=function(e){e.replaceWith(this.$form),this.offset=this.$form.offset(),this.$form.on("keydown","input,select",(function(e){if(13===e.keyCode)return!1}))},ns.Form.prototype.remove=function(){ns.removeChildren(this.metadataForm.children),ns.removeChildren(this.children),ns.renderableCommonFields={},this.$form.remove()},ns.Form.prototype.processSemantics=function(e,t,a){if(this.metadata=a||(t.metadata||{}),this.metadata.defaultLanguage||(this.metadata.defaultLanguage=ns.defaultLanguage),ns.enableMetadata(this.currentLibrary))this.metadataForm=new ns.MetadataForm(this,this.metadata,this.$form.children(".tree"),!0);else switch(this.metadataForm=H5PEditor.MetadataForm.createLegacyForm(this.metadata,this.$form.children(".tree")),this.currentLibrary.split(" ")[0]){case"H5P.InteractiveVideo":case"H5P.DragQuestion":case"H5P.ImageHotspotQuestion":this.metadataForm.getExtraTitleField().$item.css("padding","20px 20px 0 20px");break;case"H5P.CoursePresentation":this.metadataForm.getExtraTitleField().$item.css("padding-bottom","1em")}this.params=t.params?t.params:t,ns.processSemanticsChunk(e,this.params,this.$form.children(".tree"),this)},ns.Form.prototype.ready=function(e){this.readies.push(e)};