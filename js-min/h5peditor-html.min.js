ns.Html=function(t,e,i,s){this.parent=t,this.field=e,this.value=i,this.setValue=s,this.tags=ns.$.merge(["br"],this.field.tags||this.defaultTags)},ns.Html.first=!0,ns.Html.prototype.defaultTags=["strong","em","del","h2","h3","a","ul","ol","table","hr"],ns.Html.prototype.inTags=function(t){return ns.$.inArray(t.toLowerCase(),this.tags)>=0},ns.Html.prototype.inButtons=function(t){return void 0!==H5PIntegration.editor&&void 0!==H5PIntegration.editor.wysiwygButtons&&-1!==H5PIntegration.editor.wysiwygButtons.indexOf(t)},ns.Html.prototype.createToolbar=function(){var t=[],e=[],i=[],s=[],n=[];if((this.inTags("strong")||this.inTags("b"))&&(t.push("Bold"),this.tags.push("strong")),(this.inTags("em")||this.inTags("i"))&&(t.push("Italic"),this.tags.push("em")),this.inTags("u")&&t.push("Underline"),(this.inTags("strike")||this.inTags("del")||this.inTags("s"))&&(t.push("Strike"),this.tags.push("strike"),this.tags.push("del"),this.tags.push("s")),this.inTags("sub")&&t.push("Subscript"),this.inTags("sup")&&t.push("Superscript"),t.length>0&&(t.push("-"),t.push("RemoveFormat"),n.push({name:"basicstyles",items:t})),n.push({name:"justify",items:["JustifyLeft","JustifyCenter","JustifyRight"]}),this.inTags("ul")&&(e.push("BulletedList"),this.tags.push("li")),this.inTags("ol")&&(e.push("NumberedList"),this.tags.push("li")),this.inTags("blockquote")&&e.push("Blockquote"),e.length>0&&n.push(e),this.inTags("a")){var o=["Link","Unlink"];this.inTags("anchor")&&o.push("Anchor"),n.push({name:"links",items:o})}this.inTags("img")&&s.push("Image"),this.inTags("table")&&(s.push("Table"),ns.$.merge(this.tags,["tr","td","th","colgroup","thead","tbody","tfoot"])),this.inTags("hr")&&s.push("HorizontalRule"),this.inTags("code")&&(this.inButtons("inlineCode")&&s.push("Code"),this.inTags("pre")&&this.inButtons("codeSnippet")&&s.push("CodeSnippet")),s.length>0&&n.push({name:"insert",items:s});var r={name:"styles",items:[]},a={name:"colors",items:[]};this.inTags("h1")&&i.push("h1"),this.inTags("h2")&&i.push("h2"),this.inTags("h3")&&i.push("h3"),this.inTags("h4")&&i.push("h4"),this.inTags("h5")&&i.push("h5"),this.inTags("h6")&&i.push("h6"),this.inTags("address")&&i.push("address"),this.inTags("pre")&&i.push("pre"),(i.length>0||this.inTags("p")||this.inTags("div"))&&(i.push("p"),this.tags.push("p"),r.items.push("Format"));var h={toolbar:n};if(void 0!==this.field.font){this.tags.push("span");var l=function(t,e,i){h[e]="";for(var s=0;s<t.length;s++){var n=t[s];n.label&&n.css&&(h[e]+=n.label+"/"+n.css+";",i&&n.default&&(h[i]=n.label))}},d=function(t){for(var e="",i=0;i<t.length;i++){var s=t[i];if(s.label&&s.css){var n=s.css.match(/^#?([a-f0-9]{3}[a-f0-9]{3}?)$/i);if(!n)continue;e&&(e+=","),e+=s.label+"/"+n[1]}}return e};if(this.field.font.family&&(r.items.push("Font"),this.field.font.family instanceof Array&&l(this.field.font.family,"font_names","font_defaultLabel")),this.field.font.size)if(r.items.push("FontSize"),h.fontSize_sizes="",this.field.font.size instanceof Array)l(this.field.font.size,"fontSize_sizes","fontSize_defaultLabel");else{h.fontSize_defaultLabel="100%";for(var p=[8,9,10,11,12,14,16,18,20,22,24,26,28,36,48,72],u=0;u<p.length;u++){var c=p[u]/16;h.fontSize_sizes+=100*c+"%/"+c+"em;"}}this.field.font.color&&(a.items.push("TextColor"),this.field.font.color instanceof Array&&(h.colorButton_colors=d(this.field.font.color),h.colorButton_enableMore=!1)),this.field.font.background&&(a.items.push("BGColor"),this.field.font.background instanceof Array&&(h.colorButton_colors=d(this.field.font.color),h.colorButton_enableMore=!1))}return r.items.length&&n.push(r),a.items.length&&n.push(a),i.length&&(h.format_tags=i.join(";")),"p"===this.field.enterMode||i.length>0?(this.tags.push("p"),h.enterMode=CKEDITOR.ENTER_P):(this.tags.push("div"),h.enterMode=CKEDITOR.ENTER_DIV),h},ns.Html.prototype.appendTo=function(t){var e=this;this.$item=ns.$(this.createHtml()).appendTo(t),this.$input=this.$item.children(".ckeditor"),this.$errors=this.$item.children(".h5p-errors"),ns.bindImportantDescriptionEvents(this,this.field.name,this.parent);var i={extraPlugins:"",startupFocus:!0,enterMode:CKEDITOR.ENTER_DIV,allowedContent:!0,protectedSource:[],contentsCss:ns.basePath+"styles/css/cke-contents.css",codeSnippet_codeClass:"h5p-hl"};if(ns.$.extend(i,this.createToolbar()),ns.HtmlAddons)for(var s in ns.HtmlAddons)if(e.inTags(s))for(var n in ns.HtmlAddons[s])ns.HtmlAddons[s][n](i,e.tags);this.$item.children(".ckeditor").focus((function(){var t=!1;if(e.$placeholder=e.$item.find(".h5peditor-ckeditor-placeholder").detach(),ns.Html.first&&(CKEDITOR.basePath=ns.basePath+"/ckeditor/"),ns.Html.current!==e){ns.Html.removeWysiwyg(),CKEDITOR.document.getBody=function(){return new CKEDITOR.dom.element(window.document.body)},CKEDITOR.tools.convertToPx=function(t){const e=CKEDITOR.dom.element.createFromHtml('<div style="position:absolute;left:-9999px;top:-9999px;margin:0px;padding:0px;border:0px;"></div>',CKEDITOR.document);if(CKEDITOR.document.getBody().append(e),!/%$/.test(t)){var i,s=parseFloat(t)<0;return s&&(t=t.replace("-","")),e.setStyle("width",t),i=e.$.clientWidth,e.$&&e.$.parentNode&&e.$.parentNode.removeChild(e.$),s?-i:i}return e.$&&e.$.parentNode&&e.$.parentNode.removeChild(e.$),t},ns.Html.current=e,i.width=this.offsetWidth-8,e.ckeditor=CKEDITOR.replace(this,i),e.ckeditor.on("focus",(function(){t=!1})),e.ckeditor.once("destroy",(function(){t||s();var i=void 0!==e.ckeditor?e.ckeditor.getData():e.$input.html();0===e.$placeholder.length||void 0!==i&&0!==i.length||void 0!==e.value&&0!==e.value.length||e.$placeholder.appendTo(e.$item.find(".ckeditor"))}));var s=function(){t=!0,e.$item.is(":visible")&&e.validate()};e.ckeditor.on("blur",s),ns.Html.first&&(CKEDITOR.on("dialogDefinition",(function(t){var e=t.data.name,i=t.data.definition;"link"===e&&(i.getContents("target").get("linkTargetType").default="_blank");var s=i.onShow;i.onShow=function(){void 0!==s&&s.apply(this,arguments);var t=ns.Html.current.$item,e=t[0].getBoundingClientRect(),i=this.getSize(),n=e.x+e.width/2-i.width/2,o=e.y+e.height/2-i.height/2;this.move(n,o,!0)}})),ns.Html.first=!1)}}))},ns.Html.prototype.createHtml=function(){const t=ns.getNextFieldId(this.field);var e='<div id="'+t+'"';return void 0!==this.field.description&&(e+=' aria-describedby="'+ns.getDescriptionId(t)+'"'),e+=' class="ckeditor" tabindex="0" contenteditable="true">',void 0!==this.value?e+=this.value:void 0!==this.field.placeholder&&(e+='<span class="h5peditor-ckeditor-placeholder">'+this.field.placeholder+"</span>"),e+="</div>",ns.createFieldMarkup(this.field,ns.createImportantDescription(this.field.important)+e,t)},ns.Html.prototype.validate=function(){var t=this;t.$errors.children().length&&(t.$errors.empty(),this.$input.addClass("error"));var e=void 0!==this.ckeditor?this.ckeditor.getData():this.$input.html();e=e.replace(/<span class="h5peditor-ckeditor-placeholder">.*<\/span>/,"").replace(/^<br>$/,"");var i=ns.$("<div>"+e+"</div>"),s=i.text();return this.field.optional||s.length||this.inTags("img")&&i.find("img").length>0||this.$errors.append(ns.createError(ns.t("core","requiredProperty",{":property":ns.t("core","textField")}))),i.find("*").each((function(){t.inTags(this.tagName)||ns.$(this).replaceWith(ns.$(this).contents())})),e=i.html(),!t.$errors.children().length&&(this.$input.removeClass("error"),this.value=e,this.setValue(this.field,e),this.$input.change(),e)},ns.Html.removeWysiwyg=function(){if(void 0!==ns.Html.current){try{ns.Html.current.ckeditor.destroy()}catch(t){}ns.Html.current=void 0}},ns.Html.prototype.remove=function(){this.$item.remove()},ns.Html.prototype.forceValue=function(t){void 0===this.ckeditor?this.$input.html(t):this.ckeditor.setData(t),this.validate()},ns.widgets.html=ns.Html;