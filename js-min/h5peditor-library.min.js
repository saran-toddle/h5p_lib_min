ns.Library=function(r,e,t,a){var i=this;H5P.EventDispatcher.call(this),void 0===t?(this.params={params:{}},a(e,this.params)):this.params=t,this.field=e,this.parent=r,this.changes=[],this.optionsLoaded=!1,this.library=r.library+"/"+e.name,this.passReadies=!0,r.ready((function(){i.passReadies=!1})),this.confirmChangeLibrary=new H5P.ConfirmationDialog({headerText:H5PEditor.t("core","changeLibrary"),dialogText:H5PEditor.t("core","confirmChangeLibrary")}).appendTo(document.body),this.confirmChangeLibrary.on("confirmed",(function(){i.loadLibrary(i.$select.val())})),this.confirmChangeLibrary.on("canceled",(function(){i.$select.val(i.currentLibrary)})),H5P.externalDispatcher.on("datainclipboard",this.updateCopyPasteButtons.bind(this))},ns.Library.prototype=Object.create(H5P.EventDispatcher.prototype),ns.Library.prototype.constructor=ns.Library,ns.Library.prototype.updateCopyPasteButtons=function(){if(!window.localStorage||!this.libraries)return;const r=ns.canPastePlus(H5P.getClipboard(),this.libraries),e=r.canPaste,t=void 0!==this.currentLibrary&&"-"!==this.currentLibrary;this.$copyButton.prop("disabled",!t).toggleClass("disabled",!t),this.$pasteButton.text(ns.t("core",t?"pasteAndReplaceButton":"pasteButton")).attr("title",e?H5PEditor.t("core","pasteFromClipboard"):r.description).toggleClass("disabled",!e).prop("disabled",!e)},ns.Library.prototype.appendTo=function(r){var e=this,t='<div class="field '+this.field.type+'">';const a=ns.getNextFieldId(this.field);0!==this.field.label&&void 0!==this.field.label&&(t+='<div class="h5p-editor-flex-wrapper"><label class="h5peditor-label-wrapper" for="'+a+'"><span class="h5peditor-label'+(this.field.optional?"":" h5peditor-required")+'">'+this.field.label+"</span></label></div>"),t+=ns.createDescription(this.field.description,a),t+='<select id="'+a+'"',void 0!==this.field.description&&(t+=' aria-describedby="'+ns.getDescriptionId(a)+'"'),t+=">"+ns.createOption("-","Loading...")+"</select>";window.localStorage&&function(){var r=ns.findLibraryAncestor(e.parent);if(void 0!==r.currentLibrary){var t=ns.libraryFromString(r.currentLibrary),a={"H5P.CoursePresentation":{major:1,minor:20},"H5P.InteractiveVideo":{major:1,minor:20},"H5P.DragQuestion":{major:1,minor:13}}[t.machineName];return void 0===a||(t.majorVersion>a.major||t.majorVersion==a.major&&t.minorVersion>=a.minor)}return!0}()&&(t+=ns.createCopyPasteButtons()),t+='<div class="libwrap"></div>',t+="</div>",this.$myField=ns.$(t).appendTo(r),this.$select=this.$myField.children("select"),this.$label=this.$myField.find(".h5peditor-label"),this.$clearfix=this.$myField.children(".h5peditor-clearfix"),this.$libraryWrapper=this.$myField.children(".libwrap"),window.localStorage&&(this.$copyButton=this.$myField.find(".h5peditor-copy-button").click((function(){e.validate(),H5P.clipboardify(e.params),ns.attachToastTo(e.$copyButton.get(0),H5PEditor.t("core","copiedToClipboard"),{position:{horizontal:"center",vertical:"above",noOverflowX:!0}})})),this.$pasteButton=this.$myField.find(".h5peditor-paste-button").click(e.pasteContent.bind(this))),ns.LibraryListCache.getLibraries(e.field.options,e.librariesLoaded,e)},ns.Library.prototype.hide=function(){this.$label.hide(),this.$libraryWrapper.addClass("no-margin"),this.hideLibrarySelector(),this.hideCopyPaste()},ns.Library.prototype.hideLibrarySelector=function(){this.$myField.children("select").hide()},ns.Library.prototype.hideCopyPaste=function(){this.$myField.children(".h5peditor-copypaste-wrap").hide()},ns.Library.prototype.pasteContent=function(){var r=this;const e=H5P.getClipboard();ns.canPaste(e,r.libraries)?ns.confirmReplace(this.params.library,this.$select.offset().top,(function(){for(var t in r.$select.val(e.generic.library),r.params)r.params.hasOwnProperty(t)&&delete r.params[t];for(t in e.generic)e.generic.hasOwnProperty(t)&&(r.params[t]=e.generic[t]);r.loadLibrary(e.generic.library,!0)})):console.error("Tried to paste unsupported sub-content")},ns.Library.prototype.confirmReplace=function(r){if(this.params.library){var e=new H5P.ConfirmationDialog({headerText:H5PEditor.t("core","changeLibrary"),dialogText:H5PEditor.t("core","confirmChangeLibrary")}).appendTo(document.body);e.on("confirmed",r),e.show(this.$select.offset().top)}else r()},ns.Library.prototype.librariesLoaded=function(r){var e=this;this.libraries=r;for(var t=ns.createOption("-","-"),a=0;a<e.libraries.length;a++){var i=e.libraries[a];i.uberName!==e.params.library&&(void 0===i.title||void 0!==i.restricted&&i.restricted)||(t+=ns.createOption(i.uberName,i.title,i.uberName===e.params.library))}e.$select.html(t).change((function(){setTimeout((function(){e.params.library?e.confirmChangeLibrary.show(e.$select.offset().top):e.loadLibrary(e.$select.val())}),0)})),1===e.libraries.length&&(e.$select.hide(),e.$myField.children(".h5p-editor-flex-wrapper").hide(),e.$clearfix.hide(),e.loadLibrary(e.$select.children(":last").val(),!0)),e.updateCopyPasteButtons(),!0===e.runChangeCallback&&(e.change(),e.runChangeCallback=!1),void 0!==this.params.library&&e.loadLibrary(this.params.library,!0)},ns.Library.prototype.loadLibrary=function(r,e){var t=this;if(this.removeChildren(),"-"===r)return delete this.params.library,delete this.params.params,delete this.params.subContentId,delete this.params.metadata,this.$libraryWrapper.attr("class","libwrap"),this.updateCopyPasteButtons(),void this.change();this.$libraryWrapper.html(ns.t("core","loading")).attr("class","libwrap "+r.split(" ")[0].toLowerCase().replace(".","-")+"-editor"+(1===this.libraries.length?" no-margin":"")),ns.loadLibrary(r,(function(a){const i=t.findLibrary(r);if(void 0===i)return t.loadLibrary("-"),void t.$libraryWrapper.html(ns.createError(ns.t("core","unknownLibrary",{"%lib":r}))).attr("class","libwrap errors "+r.split(" ")[0].toLowerCase().replace(".","-")+"-editor"+(1===t.libraries.length?" no-margin":""));t.currentLibrary=r,t.params.library=r,void 0!==e&&e||(delete t.params.subContentId,t.params.params={},t.params.metadata={}),void 0===t.params.subContentId&&(t.params.subContentId=H5P.createUUID()),void 0===t.params.metadata&&(t.params.metadata={}),t.$libraryWrapper.html("");ns.findAncestor(t.parent).addLanguages(i.uberName,ns.libraryCache[i.uberName].languages),t.params.metadata.contentType=i.title;const s=t.getLibraryMetadataSettings(i);if(s.disable?t.metadataForm=null:t.metadataForm=new ns.MetadataForm(t,t.params.metadata,t.$libraryWrapper,!s.disableExtraTitleField,!0),ns.processSemanticsChunk(a,t.params.params,t.$libraryWrapper,t),t.updateCopyPasteButtons(),t.metadataForm&&s.disableExtraTitleField)for(let r=0;r<t.children.length;r++)if(t.children[r].$item){t.metadataForm.appendButtonTo(t.children[r].$item);break}void 0!==t.libraries?t.change():t.runChangeCallback=!0}))},ns.Library.prototype.findLibrary=function(r){const e=this;for(let t=0;t<e.libraries.length;t++)if(e.libraries[t].uberName===r)return e.libraries[t]},ns.Library.prototype.getLibraryMetadataSettings=function(r){return r.metadataSettings?r.metadataSettings:{disable:!ns.enableMetadata(r.uberName),disableExtraTitleField:!1}},ns.Library.prototype.change=function(r){if(void 0!==r)this.changes.push(r);else{var e,t;for(t=0;t<this.libraries.length;t++)if(this.libraries[t].uberName===this.params.library){e=this.libraries[t];break}for(t=0;t<this.changes.length;t++)this.changes[t](e)}},ns.Library.prototype.validate=function(){var r=!0;if(this.metadataForm&&this.metadataForm.children)for(var e=0;e<this.metadataForm.children.length;e++)!1===this.metadataForm.children[e].validate()&&(r=!1);if(this.children)for(e=0;e<this.children.length;e++)!1===this.children[e].validate()&&(r=!1);else this.libraries&&this.libraries.length&&(r=!1);return!!this.field.optional||r},ns.Library.prototype.ready=function(r){this.passReadies?this.parent.ready(r):this.readies.push(r)},ns.Library.prototype.removeChildren=function(){if(this.metadataForm&&void 0!==this.metadataForm.children&&ns.removeChildren(this.metadataForm.children),"-"===this.currentLibrary||void 0===this.children)return;this.$metadataFormWrapper&&(this.$metadataFormWrapper.remove(),delete this.$metadataFormWrapper,this.$metadataButton.remove(),delete this.$metadataButton);var r=ns.findAncestor(this.parent);for(var e in r.commonFields)if(e===this.currentLibrary){var t=!1;for(var a in r.commonFields[e]){var i=r.commonFields[e][a];1===i.parents.length&&(i.instance.remove(),t=!0);for(var s=0;s<i.parents.length;s++)i.parents[s]===this&&(i.parents.splice(s,1),i.setValues.splice(s,1))}t&&(delete r.commonFields[e],ns.$(ns.renderableCommonFields[e].wrapper).remove())}const n=this.findLibrary(this.currentLibrary);r.removeLanguages(n.uberName,ns.libraryCache[n.uberName].languages),ns.removeChildren(this.children)},ns.Library.prototype.forEachChild=function(r){for(var e=0;e<this.children.length;e++)if(r(this.children[e],e))return},ns.Library.prototype.remove=function(){this.removeChildren(),void 0!==this.$select&&this.$select.parent().remove()},ns.widgets.library=ns.Library;