H5PEditor.widgets.video=H5PEditor.widgets.audio=H5PEditor.AV=function(e){function t(t,i,a,d){var o=this;H5PEditor.FileUploader.call(o,i),this.parent=t,this.field=i,this.params=a,this.setValue=d,this.changes=[],void 0!==a&&void 0!==a[0]&&this.setCopyright(a[0].copyright),o.on("upload",(function(){o.$uploading=e('<div class="h5peditor-uploading h5p-throbber">'+H5PEditor.t("core","uploading")+"</div>").insertAfter(o.$add.hide()),o.$errors.html(""),o.closeDialog()})),o.on("uploadProgress",(function(e){o.$uploading.html(H5PEditor.t("core","uploading")+" "+Math.round(100*e.data)+" %")})),o.on("uploadComplete",(function(e){var t=e.data;this.$addDialog.find(".h5p-file-url").val("");try{if(t.error)throw t.error;void 0===o.params&&(o.params=[],o.setValue(o.field,o.params));var i={path:t.data.path,mime:t.data.mime,copyright:o.copyright},a=void 0!==o.updateIndex?o.updateIndex:o.params.length;o.params[a]=i,o.addFile(a);for(var d=0;d<o.changes.length;d++)o.changes[d](i)}catch(e){o.$errors.append(H5PEditor.createError(e))}void 0!==o.$uploading&&0!==o.$uploading.length&&(o.$uploading.remove(),o.$add.show())}))}t.prototype=Object.create(ns.FileUploader.prototype),t.prototype.constructor=t,t.prototype.appendTo=function(i){var a=this;const d=ns.getNextFieldId(this.field);var o='<ul class="file list-unstyled"></ul>'+(a.field.widgetExtensions?t.createTabbedAdd(a.field.type,a.field.widgetExtensions,d,void 0!==a.field.description):t.createAdd(a.field.type,d,void 0!==a.field.description));this.field.disableCopyright||(o+='<a class="h5p-copyright-button" href="#">'+H5PEditor.t("core","editCopyright")+"</a>"),o+='<div class="h5p-editor-dialog"><a href="#" class="h5p-close" title="'+H5PEditor.t("core","close")+'"></a></div>';var r=H5PEditor.createFieldMarkup(this.field,o,d),l=e(r).appendTo(i);this.$files=l.children(".file"),this.$add=l.children(".h5p-add-file").click((function(){a.$addDialog.addClass("h5p-open")}));const n=0,s=1;let c=n;const h=function(e){return e>s},p=function(){h(c)&&v[c].pause(),this.parentElement.querySelector(".selected").classList.remove("selected"),this.classList.add("selected");const e=document.getElementById(this.getAttribute("aria-controls"));e.parentElement.querySelector(".av-tabpanel:not([hidden])").setAttribute("hidden",""),e.removeAttribute("hidden");for(let t=0;t<e.parentElement.children.length;t++)if(e.parentElement.children[t]===e){c=t-1;break}a.$insertButton[0].disabled=c===n||c!==s&&!v[c].hasMedia()},u=function(e){e&&(this.setAttribute("tabindex","-1"),e.setAttribute("tabindex","0"),e.focus())};l.find(".av-tab").click(p).keydown((function(e){13===e.which||32===e.which?(p.call(this,e),e.preventDefault()):37===e.which||38===e.which?(u.call(this,this.previousSibling),e.preventDefault()):39!==e.which&&40!==e.which||(u.call(this,this.nextSibling),e.preventDefault())})),this.$addDialog=this.$add.next().children().first();const v=[null,null];if(a.tabInstances=v,a.field.widgetExtensions){const e=function(e,t){const i=new H5PEditor.AV[e];i.appendTo(a.$addDialog[0].children[0].children[t+1]),i.on("hasMedia",(function(e){t===c&&(a.$insertButton[0].disabled=!e.data)})),v.push(i)};for(let t=0;t<a.field.widgetExtensions.length;t++)H5PEditor.AV[a.field.widgetExtensions[t]]&&e(a.field.widgetExtensions[t],t+2)}var f=this.$url=this.$addDialog.find(".h5p-file-url");if(this.$addDialog.find(".h5p-cancel").click((function(){a.updateIndex=void 0,a.closeDialog()})),this.$addDialog.find(".h5p-file-drop-upload").addClass("has-advanced-upload").on("drag dragstart dragend dragover dragenter dragleave drop",(function(e){e.preventDefault(),e.stopPropagation()})).on("dragover dragenter",(function(t){e(this).addClass("over"),t.originalEvent.dataTransfer.dropEffect="copy"})).on("dragleave",(function(){e(this).removeClass("over")})).on("drop",(function(e){a.uploadFiles(e.originalEvent.dataTransfer.files)})).click((function(){a.openFileSelector()})),this.$insertButton=this.$addDialog.find(".h5p-insert").click((function(){if(h(c)){const e=v[c].getMedia();e&&a.upload(e.data,e.name)}else{const e=f.val().trim();e&&a.useUrl(e)}a.closeDialog()})),this.$errors=l.children(".h5p-errors"),void 0!==this.params)for(var g=0;g<this.params.length;g++)this.addFile(g);else l.find(".h5p-copyright-button").addClass("hidden");var m=l.find(".h5p-editor-dialog");l.find(".h5p-copyright-button").add(m.find(".h5p-close")).click((function(){return m.toggleClass("h5p-open"),!1})),ns.File.addCopyright(a,m,(function(e,t){a.setCopyright(t)}))},t.prototype.addFile=function(i){var a,d=this,o=this.params[i],r="h5p-av-"+t.getNextId(),l=H5PEditor.t("core","videoQualityDefaultLabel",{":index":i+1}),n=o.metadata&&o.metadata.qualityName?o.metadata.qualityName:l,s=t.providers.filter((function(e){return"YouTube"===e.name}))[0].regexp,c=o.path&&o.path.match(s);(c&&(d.$files.children().each((function(t){t!==d.updateIndex&&d.removeFileWithElement(e(this))})),d.$files.children().each((function(){e(this).remove()})),i=0),this.$add.toggleClass("hidden",!!c),void 0!==d.updateIndex)&&(this.$files.children(":eq("+i+")").remove(),this.updateIndex=void 0);a=!0!==this.field.enableCustomQualityLabel||c?'<li class="h5p-av-cell"><div class="h5p-thumbnail"><div class="h5p-type" title="'+o.mime+'">'+o.mime.split("/")[1]+'</div><div role="button" tabindex="0" class="h5p-remove" title="'+H5PEditor.t("core","removeFile")+'"></div></li>':'<li class="h5p-av-row"><div class="h5p-thumbnail"><div class="h5p-type" title="'+o.mime+'">'+o.mime.split("/")[1]+'</div><div role="button" tabindex="0" class="h5p-remove" title="'+H5PEditor.t("core","removeFile")+'"></div></div><div class="h5p-video-quality"><div class="h5p-video-quality-title">'+H5PEditor.t("core","videoQuality")+'</div><label class="h5peditor-field-description" for="'+r+'">'+H5PEditor.t("core","videoQualityDescription")+'</label><input id="'+r+'" class="h5peditor-text" type="text" maxlength="60" value="'+n+'"></div></li>';var h=e(a);i>=d.$files.children().length?h.appendTo(d.$files):h.insertBefore(d.$files.children().eq(i)),this.$add.parent().find(".h5p-copyright-button").removeClass("hidden"),h.children(".h5p-thumbnail").click((function(){d.$add.is(":visible")&&(d.$addDialog.addClass("h5p-open").find(".h5p-file-url").val(d.params[i].path),d.updateIndex=i)})),h.find(".h5p-remove").click((function(){return d.$add.is(":visible")&&p.show(h.offset().top),!1})),h.find("input").change((function(){o.metadata={qualityName:e(this).val()}}));var p=new H5P.ConfirmationDialog({headerText:H5PEditor.t("core","removeFile"),dialogText:H5PEditor.t("core","confirmRemoval",{":type":"file"})}).appendTo(document.body);p.on("confirmed",(function(){d.removeFileWithElement(h),0===d.$files.children().length&&d.$add.parent().find(".h5p-copyright-button").addClass("hidden")}))},t.prototype.removeFileWithElement=function(e){var t=e.index();1===this.params.length?(delete this.params,this.setValue(this.field)):this.params.splice(t,1),e.remove(),this.$add.removeClass("hidden");for(var i=0;i<this.changes.length;i++)this.changes[i]()},t.prototype.useUrl=function(e){var i,a,d;void 0===this.params&&(this.params=[],this.setValue(this.field,this.params));var o=e.match(/\.(webm|mp4|ogv|m4a|mp3|ogg|oga|wav)/i);if(null!==o)i=o[o.length-1];else for(d=0;d<t.providers.length;d++)if(t.providers[d].regexp.test(e)){i=t.providers[d].name,a=t.providers[d].aspectRatio;break}var r={path:e,mime:this.field.type+"/"+(i||"unknown"),copyright:this.copyright,aspectRatio:a||void 0},l=void 0!==this.updateIndex?this.updateIndex:this.params.length;for(this.params[l]=r,this.addFile(l),d=0;d<this.changes.length;d++)this.changes[d](r)},t.prototype.validate=function(){return!0},t.prototype.remove=function(){this.$errors.parent().remove()},t.prototype.setCopyright=function(e){if(this.copyright=e,void 0!==this.params)for(var t=0;t<this.params.length;t++)this.params[t].copyright=e},t.prototype.ready=function(e){this.passReadies?this.parent.ready(e):e()},t.prototype.closeDialog=function(){this.$addDialog.removeClass("h5p-open"),this.$url.val("");for(let e=0;e<this.tabInstances.length;e++)this.tabInstances[e]&&this.tabInstances[e].reset()},t.createInsertDialog=function(e,t,i,a){return'<div role="button" tabindex="0" id="'+i+'"'+(a?' aria-describedby="'+ns.getDescriptionId(i)+'"':"")+' class="h5p-add-file" title="'+H5PEditor.t("core","addFile")+'"></div><div class="h5p-dialog-anchor"><div class="h5p-add-dialog"><div class="h5p-add-dialog-table">'+e+'</div><div class="h5p-buttons"><button class="h5peditor-button-textual h5p-insert"'+(t?" disabled":"")+">"+H5PEditor.t("core","insert")+'</button><button class="h5peditor-button-textual h5p-cancel">'+H5PEditor.t("core","cancel")+"</button></div></div></div>"},t.createTabContent=function(e,i){const a="audio"===i;switch(e){case"BasicFileUpload":const e="av-upload-"+t.getNextId();return'<h3 id="'+e+'">'+H5PEditor.t("core",a?"uploadAudioTitle":"uploadVideoTitle")+'</h3><div class="h5p-file-drop-upload" tabindex="0" role="button" aria-labelledby="'+e+'"><div class="h5p-file-drop-upload-inner '+i+'"></div></div>';case"InputLinkURL":return"<h3>"+H5PEditor.t("core",a?"enterAudioTitle":"enterVideoTitle")+'</h3><div class="h5p-file-url-wrapper '+i+'"><input type="text" placeholder="'+H5PEditor.t("core",a?"enterAudioUrl":"enterVideoUrl")+'" class="h5p-file-url h5peditor-text"/></div>'+(a?"":'<div class="h5p-errors"></div><div class="h5peditor-field-description">'+H5PEditor.t("core","addVideoDescription")+"</div>");default:return""}},t.createTabbedAdd=function(e,i,a,d){let o;const r=["BasicFileUpload","InputLinkURL"];for(o=0;o<i.length;o++)r.push(i[o]);let l="",n="";for(o=0;o<r.length;o++){const i=r[o],a=t.getNextId();l+='<div class="av-tab'+(0===o?" selected":"")+'" tabindex="'+(0===o?0:-1)+'" role="tab" aria-selected="'+(0===o?"true":"false")+'" aria-controls="av-tabpanel-'+a+'" id="av-tab-'+a+'">'+(o>1?H5PEditor.t("H5PEditor."+i,"title"):H5PEditor.t("core","tabTitle"+i))+"</div>",n+='<div class="av-tabpanel" tabindex="-1" role="tabpanel" id="av-tabpanel-'+a+'" aria-labelledby="av-tab-'+a+'"'+(0===o?"":' hidden=""')+">"+t.createTabContent(i,e)+"</div>"}return t.createInsertDialog('<div class="av-tablist" role="tablist" aria-label="'+H5PEditor.t("core","avTablistLabel")+'">'+l+"</div>"+n,!0,a,d)},t.createAdd=function(e,i,a){return t.createInsertDialog('<div class="h5p-dialog-box">'+t.createTabContent("BasicFileUpload",e)+'</div><div class="h5p-or-vertical"><div class="h5p-or-vertical-line"></div><div class="h5p-or-vertical-word-wrapper"><div class="h5p-or-vertical-word">'+H5PEditor.t("core","or")+'</div></div></div><div class="h5p-dialog-box">'+t.createTabContent("InputLinkURL",e)+"</div>",!1,i,a)},t.providers=[{name:"YouTube",regexp:/(?:https?:\/\/)?(?:www\.)?(?:(?:youtube.com\/(?:attribution_link\?(?:\S+))?(?:v\/|embed\/|watch\/|(?:user\/(?:\S+)\/)?watch(?:\S+)v\=))|(?:youtu.be\/|y2u.be\/))([A-Za-z0-9_-]{11})/i,aspectRatio:"16:9"},{name:"Panopto",regexp:/^[^\/]+:\/\/([^\/]*panopto\.[^\/]+)\/Panopto\/.+\?id=(.+)$/i,aspectRatio:"16:9"}];let i=0;return t.getNextId=function(){return i++},t}(H5P.jQuery);